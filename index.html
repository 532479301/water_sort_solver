<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>谜题大陆——美杜莎的魔法药剂辅助工具</title>
	<style type="text/css">
		canvas {
			border: 1px solid black;
		}

		.disable-dbl-tap-zoom {
			touch-action: manipulation;
		}
	</style>
	
	<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
</head>
<body>
<h2>谜题大陆——美杜莎的魔法药剂辅助工具</h2>
<p id="status">加载OpenCV中，请等待...</p>
<div>
   	<input type="file" id="fileInput" accept="image/png, image/jpeg" style="display: none;"/>
    <table cellpadding="0" cellspacing="0" width="0" border="0">
    <tbody>
    	<tr>
        <td>
            <canvas id="canvasOutput"  class="disable-dbl-tap-zoom"></canvas>
        </td>
    	</tr>
    	<tr>
				<td align="center">
					<span id="counter"></span><p></p>
				</td>
    	</tr>
    	<tr>
				<td align="center">
        	<button type="button" id="InputButton" class="disable-dbl-tap-zoom"  style="font-size:18px">选择截屏图片</button>
					<button type="button" class="btn btn-primary btn-sm disable-dbl-tap-zoom" style="font-size:18px" id="step" disabled>
						<i class="fa fa-caret-right"></i> 下一步
					</button>
					<button type="button" class="btn btn-warning btn-sm disable-dbl-tap-zoom" style="font-size:18px" id="reset" disabled>
						<i class="fa fa-undo"></i> 重置
					</button>
				</td>
    	</tr>
    </tbody></table>
</div>
<div>
	<img id="imageSrc" alt="No Image"/>
</div>
<div>
	<canvas id="mask"></canvas>
</div>

<script src="bottle.js" type="text/javascript"></script>
<script type="text/javascript">var solver = new Object();</script>
<script src="mitidalu.js" type="text/javascript"></script>
<script src="graphics.js" type="text/javascript"></script>

<script type="text/javascript">

	let imgElement = document.getElementById('imageSrc');
	imgElement.style.display = "none";

	// mask是为了debug时显示处理中间结果的一个元素
	let mask = document.getElementById('mask');
	mask.style.display = "none";

	let inputFile = document.getElementById('fileInput');
	//inputFile.style.opacity = 0;
	inputFile.addEventListener('change', (e) => {
		imgElement.width = 1080;
		imgElement.src = URL.createObjectURL(e.target.files[0]);
	}, false);
	
	let inputButton = document.getElementById('InputButton');
	inputButton.onclick = (event) => {inputFile.click();};
	
	function ShowStatus(string) {
		document.getElementById('status').innerHTML = string;
	}

    var movingProblem = new Object();
	function onStepButtonPress() {
		let pure = pureMethod[pureIndex];
		movingProblem.bottles[pure.from].pureTo(movingProblem.bottles[pure.to]);
		gameDisplay.show(movingProblem);
        pureIndex++;
		handleButtonStatus();
	}

	function onResetButtonPress() {
		if (pureMethod.length > 0) {
			movingProblem = clone(orgProblem);
			pureIndex = 0;
			gameDisplay.show(movingProblem);
		}
		else {
			gameDisplay.show(orgProblem);
        }
        handleButtonStatus();
	}

    function handleButtonStatus() {
		// Default to disabled, then enable.
        stepButton.disabled = true;
        resetButton.disabled = true;

        if (pureMethod.length > 0) {
			if (pureIndex < pureMethod.length) {
				stepButton.disabled = false;
				if (pureIndex > 0) {
					resetButton.disabled = false;
				}
			}
			else {
                resetButton.disabled = false;
            }

            const index = pureIndex;
            const numSolutionSteps = pureMethod.length.toString();
            counter.innerHTML = ` ${index}/${numSolutionSteps}`;
        } else {
            counter.innerHTML = '问题无解';
        }
    }

	let stepButton = document.getElementById('step');
	stepButton.addEventListener('click', onStepButtonPress);
    let resetButton = document.getElementById('reset');
	resetButton.addEventListener('click', onResetButtonPress);
	let counter = document.querySelector('#counter');

	const gameDisplay = new GameDisplay('canvasOutput');
	var orgProblem = new Object();
	var pureMethod = new Array();
	var pureIndex = 0;

	imgElement.onload = function () {
		let src = cv.imread(imgElement);
		let problem = solver.init(src);
		cv.imshow('canvasOutput', src);
		src.delete();

		gameDisplay.init(problem);
		gameDisplay.show(problem);
		imgElement.width = gameDisplay.canvasSize[0];

		// 检查
		if (!CheckProblem(problem)) {
			ShowStatus('<b>瓶子组合不符合要求，无法解题！</b>');
		}
		else {
			ShowStatus('瓶子组合通过检查，可以开始解题。');
			orgProblem = clone(problem);

			// 解题
			let unknowns = GetUnknowns(problem);
			if (unknowns == 0) {
				var pure = Solve(problem);

				// 打印结果
				if (pure == null) {
					ShowStatus('找不到解决方案，问题无解!');
					pureMethod = new Array();
                    onResetButtonPress();
				}
				else {
					pureMethod = clone(pure);
					onResetButtonPress();
				}
			}
		}
	}

	function onOpenCvReady() { // eslint-disable-line no-unused-vars
		document.getElementById('status').innerHTML = '使用方法：<br>' +
			'1. 截屏.<br>' +
			'2. 点击“选择文件”按钮，选择截屏保存的图像文件. <br>' +
			'3. 若有解，点击“下一步”按钮，跟随操作.';
	}

	function onOpenCvError() { // eslint-disable-line no-unused-vars
		let element = document.getElementById('status');
		element.setAttribute('class', 'err');
		element.innerHTML = '加载OpenCV失败，无法运作.';
	}
</script>

<script async="" src="https://docs.opencv.org/3.4.16/opencv.js" type="text/javascript" onload="onOpenCvReady();" onerror="onOpenCvError();"></script>
</body>
</html>
